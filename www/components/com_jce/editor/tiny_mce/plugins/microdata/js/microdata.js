/* microdata - 1.0.10 | 19 December 2015 | http://www.joomlacontenteditor.net | Copyright (C) 2006 - 2015 Ryan Demmer. All rights reserved | GNU/GPL Version 2 - http://www.gnu.org/licenses/gpl-2.0.html */
var MicrodataDialog={settings:{},init:function(){tinyMCEPopup.restoreSelection();var self=this,ed=tinyMCEPopup.editor,se=ed.selection,n=se.getNode(),el,update=false,data;$('button#insert').click(function(e){self.insert();e.preventDefault();});$('button#help').click(function(e){self.openHelp();e.preventDefault();});tinyMCEPopup.resizeToInnerSize();$.Plugin.init();$('input, select, label','#microdata_tab').addClass('disabled').filter('input, select').prop('disabled',true);var p=ed.dom.getParent(n,'[data-microdata-itemtype],[itemtype]');if(p){update=true;$('#insert').button('option','label',tinyMCEPopup.getLang('update','Update',true));}
$('div.itemtype-options').toggle(update);$('#itemtype-new, #itemtype-replace').prop('disabled',!update).next('label').toggleClass('disabled',!update);if(window.sessionStorage){var s=sessionStorage.getItem('wf-microdata-schema');if(s){data=JSON.parse(s);}}
$('#itemtype').change(function(){if(this.value===''){$('#itemprop, #itemid','#microdata_tab').prop('disabled',true).prev('label').addClass('disabled');return;}
$('#itemprop, #itemid','#microdata_tab').prop('disabled',false).prev('label').removeClass('disabled');var props={},type=$('option:selected',this).data('name');$('div.itemprop').hide();$('span.loader').show();if(data){if(data[type]){props[type]=data[type].domainIncludes;var subClassOf=data[type].subClassOf;while(subClassOf.length){$.each(subClassOf,function(i,k){props[k]=data[k].domainIncludes;subClassOf=data[k].subClassOf;});}}
$('#itemprop').empty().append('<option value=""></option>');$.each(props,function(k,v){if(v.length){var optgroup=$('<optgroup label="'+k+'" />');$.each(v,function(i,o){var option=new Option(o.label,o.label);$(option).attr('title',ed.dom.encode(o.comment));$(optgroup).append(option);});$('#itemprop').append(optgroup);}});}
if(update){$('#itemprop').val(ed.dom.getAttrib(n,'data-microdata-itemprop')).change();$('#itemid').val(ed.dom.getAttrib(n,'data-microdata-itemid')).change();}
$('div.itemprop').show();$('span.loader').hide();});function callback(o,parent){$('span.loader').hide();$('#itemtype').removeClass('disabled').prop('disabled',false).prev().removeClass('disabled');if(!o){return false;}
$.each(o,function(k,v){var subClassOf=o[k].subClassOf;var ix=[];while(subClassOf&&subClassOf.length){$.each(subClassOf,function(i,k){if(o[k]){ix.push('-');subClassOf=o[k].subClassOf;}else{subClassOf=false;}});}
$('<option data-name="'+k+'" title="'+ed.dom.encode(v.comment)+'" value="'+v.resource+'">'+ix.join('')+' '+k+'</option>').appendTo('#itemtype').addClass(function(){return ix.length>1?false:'microdata-itemtype';});});if(parent){var itemtype=ed.dom.getAttrib(parent,'data-microdata-itemtype');itemtype=itemtype.replace('http://schema.org/','');$('#itemtype').val(itemtype).change();}}
if(!data){$.JSON.request('getSchema',[],function(o){if(!o||o.error||typeof o==='string'){if(!o.error){$.Dialog.alert(o||'Unable to load schema');}
callback(false);return;}
callback(o,p);data=o;if(window.sessionStorage){sessionStorage.setItem('wf-microdata-schema',JSON.stringify(o));}});}else{callback(data,p);}
window.focus();},insert:function(){var ed=tinyMCEPopup.editor,se=ed.selection,n=se.getNode(),elm;tinyMCEPopup.restoreSelection();var isTextSelection=(se.getContent()===se.getContent({format:'text'}));var itemtype=$('#itemtype').val();var args={'data-microdata-itemprop':itemtype?$('#itemprop').val():null,'data-microdata-itemid':itemtype?$('#itemid').val():null}
var p=ed.dom.getParent(n,'[data-microdata-itemtype]');var blocks=[];$.each(ed.schema.getBlockElements(),function(k,v){blocks.push(k.toUpperCase());});if(!p||$('#itemtype-new:visible').is(':checked')){p=ed.dom.getParent(n,blocks.join(','));if(!p||ed.dom.is(p,'[data-microdata-itemtype]')){var fmt=ed.schema.isValidChild(p,'div')?'div':'microdata';ed.formatter.apply(fmt,{'id':'__mce_tmp'});p=ed.dom.get('__mce_tmp');ed.dom.setAttrib(p,'id',null);p.innerHTML='<span>'+p.innerHTML||''+'</span>';n=p.firstChild;isTextSelection=false;}}
if(isTextSelection){if(itemtype){ed.formatter.apply('microdata',args);}else{ed.formatter.remove('microdata-remove');}}else{ed.dom.setAttribs(n,args);}
ed.dom.setAttribs(p,{'data-microdata-itemscope':itemtype?'itemscope':null,'data-microdata-itemtype':'http://schema.org/'+itemtype});ed.undoManager.add();tinyMCEPopup.close();},openHelp:function(){$.Plugin.help('microdata');}};tinyMCEPopup.onInit.add(MicrodataDialog.init,MicrodataDialog);